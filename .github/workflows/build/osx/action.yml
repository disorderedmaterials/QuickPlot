name: Build
description: Build OSX artifacts

inputs:
  qtVersion:
    type: string
    default: 6.4.2

runs:
  using: "composite"
  steps:


  # - name: Install Homebrew Dependencies
  #   if: ${{ inputs.cacheOnly == 'false' }}
  #   shell: bash
  #   run: |

  #     set -ex
  #     brew update-reset
  #     brew install ftgl ninja

  - name: Install Python Dependencies
    shell: bash
    run: |
      pip3 install aqtinstall conan==1.* --break-system-packages

  - name: Retrieve Qt Cache
    id: cache-qt
    uses: actions/cache@v4
    with:
      key: osx-qt-${{ inputs.qtVersion }}
      path: ${{ runner.temp }}/qt

  - name: Install Qt
    if: ${{ steps.cache-qt.outputs.cache-hit != 'true' }}
    shell: bash
    run: |
      export PATH="$(python3 -m site --user-base)/bin:$PATH"
      aqt install-qt --outputdir ${{ runner.temp }}/qt mac desktop ${{ inputs.qtVersion }}

  #
  # Main Build
  #

  - name: Retrieve Conan Cache
    id: cache-conan
    uses: actions/cache@v4
    with:
      key: osx-${{ runner.arch }}-conan-${{ env.conanHash }}
      path: |
        ~/.conan
        ~/.conancache

  - name: Build
    if: ${{ inputs.cacheOnly == 'false' }}
    shell: bash
    run: |
      set -ex

      # Setup paths
      export PATH="$(python3 -m site --user-base)/bin:$PATH"
      Qt6_DIR=${{ runner.temp }}/qt/${{ inputs.qtVersion }}/macos/lib/cmake/Qt6
      QT_BASE_DIR=${{ runner.temp }}/qt/${{ inputs.qtVersion }}/macos

      # Set conan cache location
      conan config set storage.download_cache="${GITHUB_WORKSPACE}/.conancache"

      # Set minimum deployment target version
      export MACOSX_DEPLOYMENT_TARGET=10.15

      # Build
      mkdir build && cd build
      cmake -DQT_BASE_DIR=$QT_BASE_DIR ../
      cmake --build . --config Release

  - name: Upload Raw Build Artifacts
    if: ${{ inputs.cacheOnly == 'false' }}
    uses: actions/upload-artifact@v4
    with:
      name: osx-${{ runner.arch }}-build-artifacts
      path: |
        ${{ github.workspace }}/build
      retention-days: 1
